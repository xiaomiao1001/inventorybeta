<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•åˆ—è¡¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f7f8fa;
        }
        .status-bar {
            background: #000;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
        }
        .nav-bar {
            background: #fff;
            border-bottom: 1px solid #e5e5e5;
        }
        .tab-item {
            transition: all 0.3s ease;
        }
        .tab-item.active {
            color: #0066cc;
            border-bottom: 2px solid #0066cc;
        }
        .filter-chip {
            background: #f0f0f0;
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 14px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        .filter-chip.active {
            background: #0066cc;
            color: white;
        }
        .order-card {
            background: #fff;
            border-radius: 12px;
            margin: 8px 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }
        .status-badge {
            border-radius: 12px;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-submitted { background: #d1ecf1; color: #0c5460; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-shipped { background: #e2e3e5; color: #383d41; }
        .status-completed { background: #d1e7dd; color: #0f5132; }
        .vehicle-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <!-- çŠ¶æ€æ  -->
    <div class="status-bar h-11 flex items-center justify-between px-6">
        <div class="flex items-center space-x-1">
            <span>9:41</span>
        </div>
        <div class="flex items-center space-x-1">
            <i class="fas fa-signal text-sm"></i>
            <i class="fas fa-wifi text-sm"></i>
            <i class="fas fa-battery-three-quarters text-sm"></i>
        </div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <div class="nav-bar h-16 flex items-center justify-between px-4">
        <div class="flex items-center space-x-4">
            <i class="fas fa-chevron-left text-gray-600 text-lg"></i>
            <h1 class="text-lg font-semibold text-gray-800">æˆ‘çš„è®¢å•</h1>
        </div>
        <i class="fas fa-search text-gray-600"></i>
    </div>

    <!-- Tabå¯¼èˆª -->
    <div class="bg-white px-4 flex">
        <div class="tab-item flex-1 text-center py-3 font-medium text-gray-500">ä¸‹å•</div>
        <div class="tab-item active flex-1 text-center py-3 font-medium">è®¢å•</div>
    </div>

    <!-- çŠ¶æ€ç­›é€‰ -->
    <div class="bg-white px-4 py-3 border-b border-gray-100">
        <div class="flex space-x-2 overflow-x-auto">
            <div class="filter-chip active whitespace-nowrap">å…¨éƒ¨</div>
            <div class="filter-chip whitespace-nowrap">å¾…æäº¤</div>
            <div class="filter-chip whitespace-nowrap">å·²æäº¤</div>
            <div class="filter-chip whitespace-nowrap">å·²è°ƒè½¦</div>
            <div class="filter-chip whitespace-nowrap">å·²å‘è´§</div>
            <div class="filter-chip whitespace-nowrap">å·²å®Œæˆ</div>
        </div>
    </div>

    <!-- æ‰¹é‡æ“ä½œæ  -->
    <div id="batchOperations" class="bg-blue-50 px-4 py-3 border-b border-blue-200" style="display: none;">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <input type="checkbox" id="selectAll" class="mr-2 w-4 h-4 text-blue-600 rounded">
                <label for="selectAll" class="text-sm text-gray-700">å…¨é€‰</label>
                <span id="selectedCount" class="ml-3 text-sm text-blue-600">å·²é€‰æ‹© 0 é¡¹</span>
            </div>
            <div class="space-x-2">
                <button id="batchDelete" class="px-3 py-1 bg-gray-100 text-gray-600 rounded text-sm">æ‰¹é‡åˆ é™¤</button>
                <button id="batchSubmit" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">æ‰¹é‡æäº¤</button>
            </div>
        </div>
    </div>

    <!-- è®¢å•åˆ—è¡¨ -->
    <div class="pb-8" id="ordersList">
        <!-- è®¢å•å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
    </div>

    <!-- ç©ºçŠ¶æ€ -->
    <div id="emptyState" class="text-center py-16 px-4" style="display: none;">
        <div class="text-6xl mb-4">ğŸ“‹</div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">æš‚æ— è®¢å•</h3>
        <p class="text-gray-500 mb-6">æ‚¨è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•è®¢å•</p>
        <button class="bg-blue-500 text-white px-6 py-3 rounded-lg font-medium" onclick="goToOrder()">
            ç«‹å³ä¸‹å•
        </button>
    </div>

    <script>
        // è®¢å•çŠ¶æ€æ˜ å°„
        const statusMap = {
            'pending': { text: 'å¾…æäº¤', class: 'status-pending' },
            'submitted': { text: 'å·²æäº¤', class: 'status-submitted' },
            'confirmed': { text: 'å·²è°ƒè½¦', class: 'status-confirmed' },
            'shipped': { text: 'å·²å‘è´§', class: 'status-shipped' },
            'completed': { text: 'å·²å®Œæˆ', class: 'status-completed' }
        };

        // å½“å‰ç­›é€‰çŠ¶æ€
        let currentFilter = 'all';

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
            initializeFilters();
            initializeBatchOperations();
            
            // æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœæœ‰refreshå‚æ•°åˆ™å¼ºåˆ¶åˆ·æ–°æ•°æ®
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('refresh')) {
                console.log('æ£€æµ‹åˆ°refreshå‚æ•°ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½è®¢å•æ•°æ®');
                // æ¸…é™¤URLå‚æ•°ï¼Œé¿å…é‡å¤åˆ·æ–°
                window.history.replaceState({}, document.title, window.location.pathname);
                // å¼ºåˆ¶é‡æ–°åŠ è½½æ•°æ®
                setTimeout(() => {
                    loadOrders();
                }, 100);
            }
        });

        // æ·»åŠ é¡µé¢å¯è§æ€§æ£€æµ‹ï¼Œå½“é¡µé¢é‡æ–°å˜ä¸ºå¯è§æ—¶åˆ·æ–°æ•°æ®
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('é¡µé¢é‡æ–°å˜ä¸ºå¯è§ï¼Œåˆ·æ–°è®¢å•æ•°æ®');
                loadOrders();
            }
        });

        // æ·»åŠ é¡µé¢ç„¦ç‚¹æ£€æµ‹ï¼Œå½“é¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹æ—¶åˆ·æ–°æ•°æ®
        window.addEventListener('focus', function() {
            console.log('é¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹ï¼Œåˆ·æ–°è®¢å•æ•°æ®');
            loadOrders();
        });

        // åŠ è½½è®¢å•åˆ—è¡¨
        function loadOrders() {
            try {
                const orders = JSON.parse(localStorage.getItem('dealerOrders') || '[]');
                console.log('ä»localStorageåŠ è½½çš„è®¢å•:', orders);
                
                if (orders.length === 0) {
                    showEmptyState();
                    return;
                }
                
                renderOrders(orders);
                updateBatchOperationVisibility();
            } catch (error) {
                console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
                showEmptyState();
            }
        }

        // æ¸²æŸ“è®¢å•åˆ—è¡¨
        function renderOrders(orders) {
            const ordersList = document.getElementById('ordersList');
            const emptyState = document.getElementById('emptyState');
            
            // æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶è¿‡æ»¤è®¢å•
            const filteredOrders = currentFilter === 'all' ? orders : orders.filter(order => {
                switch(currentFilter) {
                    case 'pending': return order.status === 'pending';
                    case 'submitted': return order.status === 'submitted';
                    case 'confirmed': return order.status === 'confirmed';
                    case 'shipped': return order.status === 'shipped';
                    case 'completed': return order.status === 'completed';
                    default: return true;
                }
            });
            
            if (filteredOrders.length === 0) {
                ordersList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // ç”Ÿæˆè®¢å•HTML
            ordersList.innerHTML = filteredOrders.map(order => {
                const status = statusMap[order.status] || { text: 'æœªçŸ¥çŠ¶æ€', class: 'status-pending' };
                const showCheckbox = order.status === 'pending';
                const createdDate = new Date(order.createdAt).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <div class="order-card" data-status="${order.status}" data-order-id="${order.orderNo}">
                        <div class="p-4">
                            <!-- è®¢å•å¤´éƒ¨ -->
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-2">
                                    ${showCheckbox ? `<input type="checkbox" class="order-checkbox mr-2 w-4 h-4 text-blue-600 rounded" data-order-id="${order.orderNo}">` : ''}
                                    <div>
                                        <span class="text-sm text-gray-500">è®¢å•å·:</span>
                                        <span class="text-sm font-medium text-gray-800">${order.orderNo}</span>
                                    </div>
                                </div>
                                <div class="status-badge ${status.class}">${status.text}</div>
                            </div>

                            <!-- è½¦è¾†ä¿¡æ¯ -->
                            <div class="mb-3 cursor-pointer" onclick="viewOrderDetail('${order.orderNo}')">
                                <div class="font-medium text-gray-800 mb-1">${order.vehicleSeries}-${order.vehicleModel}</div>
                                <div class="text-sm text-gray-500 mb-1">${order.vehicleConfig} Â· ${order.vehicleColor}</div>
                                <div class="text-sm text-gray-400">ç»é”€å•†: ${order.dealer}</div>
                            </div>

                            <!-- ä»·æ ¼å’Œæ“ä½œ -->
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-lg font-semibold text-red-500">Â¥${order.totalAmount.toLocaleString()}</div>
                                    <div class="text-xs text-gray-400">${createdDate}</div>
                                </div>
                                ${showCheckbox ? `
                                    <div class="space-x-2">
                                        <button class="px-3 py-1 bg-gray-100 text-gray-600 rounded text-sm" onclick="editOrder('${order.orderNo}')">ç¼–è¾‘</button>
                                        <button class="px-3 py-1 bg-orange-500 text-white rounded text-sm" onclick="submitSingleOrder('${order.orderNo}')">å•ç‹¬æäº¤</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ˜¾ç¤ºç©ºçŠ¶æ€
        function showEmptyState() {
            document.getElementById('ordersList').innerHTML = '';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('batchOperations').style.display = 'none';
        }

        // åˆå§‹åŒ–ç­›é€‰å™¨
        function initializeFilters() {
            const filterChips = document.querySelectorAll('.filter-chip');
            filterChips.forEach(chip => {
                chip.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    filterChips.forEach(c => c.classList.remove('active'));
                    // æ·»åŠ activeç±»åˆ°å½“å‰ç‚¹å‡»çš„ç­›é€‰å™¨
                    this.classList.add('active');
                    
                    // è®¾ç½®å½“å‰ç­›é€‰æ¡ä»¶
                    const filterText = this.textContent.trim();
                    switch(filterText) {
                        case 'å…¨éƒ¨': currentFilter = 'all'; break;
                        case 'å¾…æäº¤': currentFilter = 'pending'; break;
                        case 'å·²æäº¤': currentFilter = 'submitted'; break;
                        case 'å·²è°ƒè½¦': currentFilter = 'confirmed'; break;
                        case 'å·²å‘è´§': currentFilter = 'shipped'; break;
                        case 'å·²å®Œæˆ': currentFilter = 'completed'; break;
                        default: currentFilter = 'all';
                    }
                    
                    // é‡æ–°åŠ è½½è®¢å•
                    loadOrders();
                });
            });
        }

        // åˆå§‹åŒ–æ‰¹é‡æ“ä½œ
        function initializeBatchOperations() {
            // å…¨é€‰åŠŸèƒ½
            document.getElementById('selectAll').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.order-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateSelectedCount();
            });

            // æ‰¹é‡æäº¤
            document.getElementById('batchSubmit').addEventListener('click', function() {
                const selectedOrders = getSelectedOrders();
                if (selectedOrders.length === 0) {
                    alert('è¯·é€‰æ‹©è¦æäº¤çš„è®¢å•');
                    return;
                }
                
                const confirmMessage = `ç¡®è®¤æ‰¹é‡æäº¤ ${selectedOrders.length} ä¸ªè®¢å•ï¼Ÿ\n\næäº¤åå°†ç­‰å¾…å‚å®¶ç¡®è®¤è°ƒè½¦ã€‚`;
                if (confirm(confirmMessage)) {
                    batchSubmitOrders(selectedOrders);
                }
            });

            // æ‰¹é‡åˆ é™¤
            document.getElementById('batchDelete').addEventListener('click', function() {
                const selectedOrders = getSelectedOrders();
                if (selectedOrders.length === 0) {
                    alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„è®¢å•');
                    return;
                }
                
                const confirmMessage = `ç¡®è®¤åˆ é™¤ ${selectedOrders.length} ä¸ªè®¢å•ï¼Ÿ\n\nåˆ é™¤åæ— æ³•æ¢å¤ã€‚`;
                if (confirm(confirmMessage)) {
                    batchDeleteOrders(selectedOrders);
                }
            });
        }

        // æ›´æ–°æ‰¹é‡æ“ä½œæ æ˜¾ç¤ºçŠ¶æ€
        function updateBatchOperationVisibility() {
            const pendingOrders = document.querySelectorAll('[data-status="pending"]');
            const batchOperations = document.getElementById('batchOperations');
            
            if (pendingOrders.length > 0) {
                batchOperations.style.display = 'block';
                
                // ç›‘å¬å¤é€‰æ¡†å˜åŒ–
                const checkboxes = document.querySelectorAll('.order-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', updateSelectedCount);
                });
            } else {
                batchOperations.style.display = 'none';
            }
        }

        // æ›´æ–°é€‰ä¸­æ•°é‡
        function updateSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
            const count = selectedCheckboxes.length;
            document.getElementById('selectedCount').textContent = `å·²é€‰æ‹© ${count} é¡¹`;
        }

        // è·å–é€‰ä¸­çš„è®¢å•
        function getSelectedOrders() {
            const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
            return Array.from(selectedCheckboxes).map(checkbox => checkbox.dataset.orderId);
        }

        // æ‰¹é‡æäº¤è®¢å•
        function batchSubmitOrders(orderIds) {
            try {
                let orders = JSON.parse(localStorage.getItem('dealerOrders') || '[]');
                
                // æ›´æ–°è®¢å•çŠ¶æ€
                orders = orders.map(order => {
                    if (orderIds.includes(order.orderNo)) {
                        return {
                            ...order,
                            status: 'submitted',
                            submittedAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                    }
                    return order;
                });
                
                // ä¿å­˜å›localStorage
                localStorage.setItem('dealerOrders', JSON.stringify(orders));
                
                alert(`æˆåŠŸæäº¤ ${orderIds.length} ä¸ªè®¢å•ï¼`);
                
                // é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨
                loadOrders();
            } catch (error) {
                console.error('æ‰¹é‡æäº¤è®¢å•å¤±è´¥:', error);
                alert('æ‰¹é‡æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ‰¹é‡åˆ é™¤è®¢å•
        function batchDeleteOrders(orderIds) {
            try {
                let orders = JSON.parse(localStorage.getItem('dealerOrders') || '[]');
                
                // åˆ é™¤é€‰ä¸­çš„è®¢å•
                orders = orders.filter(order => !orderIds.includes(order.orderNo));
                
                // ä¿å­˜å›localStorage
                localStorage.setItem('dealerOrders', JSON.stringify(orders));
                
                alert(`æˆåŠŸåˆ é™¤ ${orderIds.length} ä¸ªè®¢å•ï¼`);
                
                // é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨
                loadOrders();
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤è®¢å•å¤±è´¥:', error);
                alert('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å•ç‹¬æäº¤è®¢å•
        function submitSingleOrder(orderNo) {
            try {
                let orders = JSON.parse(localStorage.getItem('dealerOrders') || '[]');
                
                // æ›´æ–°è®¢å•çŠ¶æ€
                orders = orders.map(order => {
                    if (order.orderNo === orderNo) {
                        return {
                            ...order,
                            status: 'submitted',
                            submittedAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                    }
                    return order;
                });
                
                // ä¿å­˜å›localStorage
                localStorage.setItem('dealerOrders', JSON.stringify(orders));
                
                alert('è®¢å•æäº¤æˆåŠŸï¼');
                
                // é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨
                loadOrders();
            } catch (error) {
                console.error('æäº¤è®¢å•å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ç¼–è¾‘è®¢å•
        function editOrder(orderNo) {
            // è·³è½¬åˆ°ä¸‹å•é¡µé¢ï¼Œå¹¶ä¼ é€’è®¢å•å·å‚æ•°
            window.location.href = `order.html?edit=${orderNo}`;
        }

        // æŸ¥çœ‹è®¢å•è¯¦æƒ…
        function viewOrderDetail(orderNo) {
            // è·³è½¬åˆ°è®¢å•è¯¦æƒ…é¡µé¢
            window.location.href = `detail.html?orderNo=${orderNo}`;
        }

        // è·³è½¬åˆ°ä¸‹å•é¡µé¢
        function goToOrder() {
            window.location.href = 'order.html';
        }

        // Tabå¯¼èˆªåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.tab-item');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabText = this.textContent.trim();
                    if (tabText === 'ä¸‹å•') {
                        window.location.href = 'order.html';
                    }
                });
            });
        });
    </script>
</body>
</html> 