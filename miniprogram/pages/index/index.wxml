<!--index.wxml-->
<view class="container">
  <!-- 优化后的用户信息头部 - 移到右上角，更小存在感 -->
  <view class="top-right-header">
    <view class="user-mini">
      <text class="welcome-mini">{{userName}}</text>
      <view class="role-tag-mini">
        <text wx:if="{{userRole === 'owner'}}" class="role-text-mini owner">所有者</text>
        <text wx:elif="{{userRole === 'admin'}}" class="role-text-mini admin">管理员</text>
        <text wx:elif="{{userRole === 'sales'}}" class="role-text-mini sales">销售人员</text>
        <text wx:elif="{{userRole === 'dealer'}}" class="role-text-mini dealer">经销商</text>
      </view>
    </view>
    <view class="logout-mini" bind:tap="onLogout">
      <t-icon name="logout" size="14px" color="#999"></t-icon>
    </view>
  </view>

  <!-- 添加间距区域 -->
  <view class="header-spacing"></view>

  <!-- 优化后的搜索框 - 更细更长 -->
  <view class="search-refined">
    <view class="search-wrapper-refined">
      <t-search 
        placeholder="搜索车辆信息/VIN码"
        bind:change="onSearchChange"
        bind:submit="onSearchSubmit"
      />
      <view class="scan-btn-refined" bind:tap="onScanCode">
        <t-icon name="scan" size="18px" color="#4285f4"></t-icon>
      </view>
    </view>
  </view>

  <!-- 统一的卡片容器 -->
  <view class="cards-container">
    <!-- 功能模块 - 统一高度 -->
    <view class="unified-card">
      <view class="card-title">功能</view>
      
      <!-- 所有者功能 -->
      <view wx:if="{{userRole === 'owner'}}" class="card-content">
        <view class="function-grid-unified">
          <view class="function-item-unified" data-route="/pages/inventory/list/list" bind:tap="onNavigateToPage">
            <t-icon name="view-list" size="20px" color="#4285f4"></t-icon>
            <text class="function-text-unified">库存管理</text>
          </view>
          <view class="function-item-unified" data-route="/pages/sale/list/list" bind:tap="onNavigateToPage">
            <t-icon name="minus-circle" size="20px" color="#4285f4"></t-icon>
            <text class="function-text-unified">销售出库管理</text>
          </view>
        </view>
      </view>

      <!-- 管理员功能 -->
      <view wx:elif="{{userRole === 'admin'}}" class="card-content">
        <view class="function-grid-unified">
          <view class="function-item-unified" 
                wx:for="{{adminFunctions}}" 
                wx:key="text"
                data-index="{{index}}"
                bind:tap="onFunctionClick">
            <t-icon name="{{item.icon}}" size="20px" color="#4285f4"></t-icon>
            <text class="function-text-unified">{{item.text}}</text>
          </view>
        </view>
      </view>

      <!-- 销售人员功能 -->
      <view wx:elif="{{userRole === 'sales'}}" class="card-content">
        <view class="function-grid-unified">
          <view class="function-item-unified" 
                wx:for="{{salesFunctions}}" 
                wx:key="text"
                data-index="{{index}}"
                bind:tap="onFunctionClick">
            <t-icon name="{{item.icon}}" size="20px" color="#4285f4"></t-icon>
            <text class="function-text-unified">{{item.text}}</text>
          </view>
        </view>
      </view>

      <!-- 经销商功能 -->
      <view wx:elif="{{userRole === 'dealer'}}" class="card-content">
        <view class="function-grid-unified">
          <view class="function-item-unified" 
                wx:for="{{dealerFunctions}}" 
                wx:key="text"
                data-index="{{index}}"
                bind:tap="onFunctionClick">
            <t-icon name="{{item.icon}}" size="20px" color="#4285f4"></t-icon>
            <text class="function-text-unified">{{item.text}}</text>
          </view>
        </view>
        <view class="dealer-notice-unified">
          <t-icon name="info-circle" size="14px" color="#ff9800"></t-icon>
          <text class="notice-text-unified">经销商功能正在开发中</text>
        </view>
      </view>
    </view>

    <!-- 库存概览 - 改为卡片列表格式 -->
    <view class="unified-card">
      <view class="card-title">库存概览</view>
      <view class="card-content">
        <view class="inventory-cards">
          <!-- 鸿日车库存卡片 -->
          <view class="sale-type-item" bind:tap="onInventoryClick" data-type="hongri">
            <view class="type-icon hongri-inventory">
              <view class="hongri-logo">
                <view class="logo-circle">
                  <view class="logo-arrow"></view>
                </view>
              </view>
            </view>
            <view class="type-content">
              <view class="type-header">
                <view class="type-name">鸿日车库存</view>
                <view class="type-badge stock-good">正常</view>
              </view>
              <view class="type-desc">VIN码、车型系列、配置管理</view>
              <view class="type-features">
                <text class="feature-tag">{{inventoryOverview.hongri}}辆在库</text>
                <text class="feature-tag">库存充足</text>
              </view>
            </view>
            <view class="type-arrow">
              <t-icon name="chevron-right" size="20px" color="#999"></t-icon>
            </view>
          </view>

          <!-- 二手车库存卡片 -->
          <view class="sale-type-item" bind:tap="onInventoryClick" data-type="secondhand">
            <view class="type-icon secondhand-inventory">
              <t-icon name="refresh" size="40px" color="#FF9800"></t-icon>
            </view>
            <view class="type-content">
              <view class="type-header">
                <view class="type-name">二手车库存</view>
                <view class="type-badge stock-warning">预警</view>
              </view>
              <view class="type-desc">旧车折抵自动添加管理</view>
              <view class="type-features">
                <text class="feature-tag">{{inventoryOverview.secondhand}}辆在库</text>
                <text class="feature-tag">需补货</text>
              </view>
            </view>
            <view class="type-arrow">
              <t-icon name="chevron-right" size="20px" color="#999"></t-icon>
            </view>
          </view>

          <!-- 其他品牌库存卡片 -->
          <view class="sale-type-item" bind:tap="onInventoryClick" data-type="others">
            <view class="type-icon other-inventory">
              <t-icon name="bulletpoint" size="40px" color="#2196F3"></t-icon>
            </view>
            <view class="type-content">
              <view class="type-header">
                <view class="type-name">其他品牌库存</view>
                <view class="type-badge stock-low">紧急</view>
              </view>
              <view class="type-desc">非鸿日品牌车辆信息</view>
              <view class="type-features">
                <text class="feature-tag">{{inventoryOverview.others}}辆在库</text>
                <text class="feature-tag">急需补货</text>
              </view>
            </view>
            <view class="type-arrow">
              <t-icon name="chevron-right" size="20px" color="#999"></t-icon>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 快速统计 - 改为卡片列表格式 -->
    <view wx:if="{{userRole === 'owner' || userRole === 'admin'}}" class="unified-card">
      <view class="card-title">快速统计</view>
      <view class="card-content">
        <view class="stats-cards">
          <!-- 本月销售卡片 -->
          <view class="sale-type-item" bind:tap="onStatsClick" data-type="monthly-sales">
            <view class="type-icon sales-stats">
              <t-icon name="chart-rising" size="40px" color="#4285f4"></t-icon>
            </view>
            <view class="type-content">
              <view class="type-header">
                <view class="type-name">本月销售</view>
                <view class="type-badge sales-badge">12辆</view>
              </view>
              <view class="type-desc">当月车辆销售统计数据</view>
              <view class="type-features">
                <text class="feature-tag">零售销售</text>
                <text class="feature-tag">批发销售</text>
                <text class="feature-tag">月度统计</text>
              </view>
            </view>
            <view class="type-arrow">
              <t-icon name="chevron-right" size="20px" color="#999"></t-icon>
            </view>
          </view>

          <!-- 待处理赊欠卡片 -->
          <view class="sale-type-item" bind:tap="onStatsClick" data-type="pending-credit">
            <view class="type-icon credit-stats">
              <t-icon name="time" size="40px" color="#FF9800"></t-icon>
            </view>
            <view class="type-content">
              <view class="type-header">
                <view class="type-name">待处理赊欠</view>
                <view class="type-badge credit-badge">3笔</view>
              </view>
              <view class="type-desc">需要跟进处理的赊欠记录</view>
              <view class="type-features">
                <text class="feature-tag">客户赊欠</text>
                <text class="feature-tag">催收提醒</text>
                <text class="feature-tag">账款管理</text>
              </view>
            </view>
            <view class="type-arrow">
              <t-icon name="chevron-right" size="20px" color="#999"></t-icon>
            </view>
          </view>

          <!-- 库存总计卡片 -->
          <view class="sale-type-item" bind:tap="onStatsClick" data-type="total-inventory">
            <view class="type-icon total-stats">
              <t-icon name="chart-pie" size="40px" color="#52C41A"></t-icon>
            </view>
            <view class="type-content">
              <view class="type-header">
                <view class="type-name">库存总计</view>
                <view class="type-badge total-badge">{{inventoryOverview.hongri + inventoryOverview.secondhand + inventoryOverview.others}}辆</view>
              </view>
              <view class="type-desc">全部车辆库存汇总统计</view>
              <view class="type-features">
                <text class="feature-tag">全库统计</text>
                <text class="feature-tag">实时更新</text>
                <text class="feature-tag">综合分析</text>
              </view>
            </view>
            <view class="type-arrow">
              <t-icon name="chevron-right" size="20px" color="#999"></t-icon>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 数据库连接测试区域 -->
  <view class="test-section">
    <view class="test-title">数据库连接测试</view>
    <button type="primary" bindtap="testDatabase" class="test-btn">测试数据库连接</button>
    <button type="default" bindtap="listTables" class="test-btn">查看数据表</button>
    <button type="default" bindtap="queryUsers" class="test-btn">查询用户数据</button>
    <button type="default" bindtap="queryCreditSituation" class="test-btn">查询赊欠情况</button>
    <button type="default" bindtap="queryUsedCars" class="test-btn">查询二手车库存</button>
    
    <view class="test-result" wx:if="{{testResult}}">
      <text class="result-title">测试结果：</text>
      <text class="result-content {{testResult.success ? 'success' : 'error'}}">
        {{testResult.message}}
      </text>
      <view wx:if="{{testResult.data}}" class="result-data">
        <text>详细信息：{{testResult.dataText}}</text>
      </view>
    </view>
  </view>
</view>
